import{d as fe,aH as _e,x as f,h as w,P as F,o as de,av as H,aR as ge,X as he,a5 as g,f as a,i as s,w as t,z as n,Y as e,aI as Y,l as p,g as _,B as C,k as D,A as d,G as J,F as B,aJ as K,c as x,a0 as ve,n as X,aG as Z,D as ye,ax as ke,E as we,_ as Ce,U as Pe,t as Ee,a2 as Te,V as Se,m as $e,ap as Oe,$ as be,a8 as Re}from"./BZrGgrSf.js";import{_ as Be}from"./CoSwSjgM.js";import{_ as Ie}from"./B7gl8e57.js";import{_ as ee}from"./BZlmaJYG.js";import{_ as Le}from"./CrcapPWm.js";import{_ as Ne}from"./B6KN3N1j.js";const Ue={key:1,class:"pageOutput-info-spinner"},Ae={key:0},De={key:1,class:"pageOutput-info-leftTime-seperate"},xe=1e3,te=.1,ae=4,P=40,We=fe({__name:"output",setup(Ge){const{isQueue:I,output:ne,isInitQueue:L,progress:h}=g(),l=_e(),E=f(0),i=f(0),N=f(!1),v=f(!1),u=f([]),G=f(!1),M=f("Starting.");let U=1,A;const y=w(()=>{const o=Math.floor(i.value/36e5),r=Math.floor(i.value%36e5/6e4),m=Math.floor(i.value%6e4/1e3);return{hours:o,minutes:r,seconds:m}}),se=w(()=>(u.value.length+h.value)/P*100),T=w(()=>u.value.length===P),oe=w(()=>!L.value&&(h.value>=0||u.value.length>0)?!0:L.value),le=w(()=>l.imageHeight/l.imageWidth*100),j=async()=>{await ve().open({name:"prompt"})||(I.value&&g().postInterrupt(),g().queueClear(),E.value=0,i.value=0,N.value=!1,u.value=[],await H(),await l.setWorkflow(),l.incrementRetryCount(),S())},re=()=>{l.incrementRetryCount(),X(x().GENERATE_UPLOAD)},ue=()=>{l.init(),X(x().GENERATE_LOOKSTYLE)},z=async()=>{if(v.value)return;const o=1e3;await Z().wait(o),i.value-=o,i.value>=0?z():i.value=0},ie=o=>{Oe().open({name:"imagePreview",options:{index:o,list:u.value,onDownloadEnd:()=>V()}})},S=async()=>{T.value||v.value||(I.value?(await Z().wait(xe),S()):(v.value=!1,g().queuePrompt({json:JSON.stringify(l.workflow),batchCount:P-u.value.length})))},V=()=>{v.value=!1,S()};return F(()=>ne.value,o=>{o&&o.length>0&&u.value.push(o[o.length-1].replace("http://127.0.0.1:8188",be().public.BASE_URL))},{deep:!0}),F(()=>h.value,(o,r)=>{if(!E.value&&r===0&&(E.value=Date.now()),o>=te&&!N.value){N.value=!0;const m=Date.now()-E.value;i.value=m*(1/te)*(P-u.value.length),z()}},{immediate:!0}),de(async()=>{await H(),S(),A=ge(()=>{U=U%3+1,M.value=" Starting "+".".repeat(U)},1e3),G.value=!0}),he(()=>{I.value&&g().postInterrupt(),g().queueClear(),A!==null&&clearInterval(A)}),(o,r)=>{const m=ye,ce=ke,$=we,O=Ce,b=Pe,pe=Re,q=Be,me=Ie,R=Ee,k=Te,Q=Se;return a(),s(Q,{class:"pageOutput",wide:""},{default:t(()=>[n(b,{gap:"36"},{default:t(()=>[e(T)?(a(),s(ee,{key:0,title:"生成が完了しました",icon:"shine"})):(a(),s(b,{key:1,class:"pageOutput-info",justify:"center",gap:"20"},{default:t(()=>[n($,{w:"48",h:"48",mt:"20",relative:""},{default:t(()=>[e(v)?(a(),s(Y,{key:0,onClick:V},{default:t(()=>[n(m,{name:"play",size:"44"})]),_:1})):p("",!0),e(i)?(a(),s(Ne,{key:2,progress:e(se),size:"48",stroke:"4"},null,8,["progress"])):(a(),_("div",Ue,[n(ce,{size:"48",stroke:"4"})]))]),_:1}),e(i)?(a(),s(O,{key:0,class:"pageOutput-info-leftTime",title2:"",extrabold:"",center:""},{default:t(()=>[e(y).hours>0?(a(),_("span",Ae,C(String(e(y).hours).padStart(2,"0")),1)):p("",!0),e(y).hours>0?(a(),_("span",De,":")):p("",!0),D("span",null,C(String(e(y).minutes).padStart(2,"0")),1),r[0]||(r[0]=D("span",{class:"pageOutput-info-leftTime-seperate"},":",-1)),D("span",null,C(String(e(y).seconds).padStart(2,"0")),1)]),_:1})):(a(),s(O,{key:1,class:"pageOutput-info-leftTime",title2:"",extrabold:"",center:""},{default:t(()=>r[1]||(r[1]=[d(" -- : -- ")])),_:1}))]),_:1})),n(R,{gap:"8",split:ae},{default:t(()=>[(a(),_(B,null,J(P,c=>n(me,{key:`pageOutput-item-${c}`,class:"pageOutput-img",per:e(le)},{default:t(()=>[e(u)[c-1]?(a(),s(Y,{key:0,onClick:W=>ie(c-1)},{default:t(()=>[n(pe,{src:e(u)[c-1],cover:""},null,8,["src"])]),_:2},1032,["onClick"])):p("",!0),!e(T)&&c-1===e(u).length?(a(),s($,{key:1,class:"pageOutput-img-progress",w:"100%",h:"100%",relative:""},{default:t(()=>[n(q,{w:"100%",h:"100%",animation:""}),n($,{absolute:"",top:"8",left:"8",color:"dark","min-w":"32",r:"4",pt:"4",pb:"4",pr:"4",pl:"4"},{default:t(()=>[e(L)&&e(h)>0?(a(),s(O,{key:0,callout:"",bold:"",center:"",color:"light","baseline-height":""},{default:t(()=>[d(C(Math.round(e(h)*100))+"% ",1)]),_:1})):(a(),s(O,{key:1,callout:"",bold:"",color:"light","baseline-height":"",style:{width:"56px"}},{default:t(()=>[d(C(e(M)),1)]),_:1}))]),_:1})]),_:1})):(a(),s(q,{key:2,w:"100%",h:"100%",animation:!e(oe),delay:c/ae*150},null,8,["animation","delay"]))]),_:2},1032,["per"])),64))]),_:1}),e(T)?(a(),s(b,{key:2,justify:"center",gap:"40"},{default:t(()=>[n(ee,{icon:"checkCircleLine",body:"生成画像は以上です"}),n(Q,null,{default:t(()=>[n(b,{justify:"stretch",gap:"20"},{default:t(()=>[n(k,{onClick:re},{default:t(()=>r[2]||(r[2]=[d(" 設定を変更してやり直す ")])),_:1}),n(k,{info:"",onClick:ue},{default:t(()=>r[3]||(r[3]=[d(" 新しい背景美術を生成する ")])),_:1})]),_:1})]),_:1})]),_:1})):p("",!0)]),_:1}),e(G)?(a(),_(B,{key:0},[(a(),s(K,{to:"#headerWideCenter"},[e(l).prompt&&e(l).prompt.length>0?(a(),s(R,{key:0,class:"headerPrompt",justify:"center",align:"center",gap:"8",nowrap:""},{default:t(()=>[n(R,{class:"headerPrompt-list",align:"center",gap:"2",fit:""},{default:t(()=>[(a(!0),_(B,null,J(e(l).prompt,(c,W)=>(a(),s(Le,$e({key:`headerPrompt-item-${W}`,ref_for:!0},{text:c}),null,16))),128))]),_:1}),n($,{class:"headerPrompt-btn",w:"40","min-w":"40",h:"40","min-h":"40"},{default:t(()=>[n(k,{class:"headerPrompt-btn-inner",w:"100%",h:"100%",onClick:j},{default:t(()=>[n(m,{name:"edit",size:"16",color:"light"})]),_:1})]),_:1})]),_:1})):!e(l).prompt||!e(l).prompt.length?(a(),s(R,{key:1,class:"headerPromptEmpty",justify:"center",align:"center",gap:"8",nowrap:""},{default:t(()=>[n(k,{xsmall:"",rounded:"",w:"160",onClick:j},{default:t(()=>[n(m,{name:"edit",size:"16",color:"light"}),!e(l).prompt||!e(l).prompt.length?(a(),_(B,{key:0},[d(" プロンプトを設定する ")],64)):p("",!0)]),_:1})]),_:1})):p("",!0)])),(a(),s(K,{to:"#headerWideRightEnd"},[n(k,{class:"headerEndBtn",minimal:"",xsmall:"",to:("useConstantsPath"in o?o.useConstantsPath:e(x))().dashboard()},{default:t(()=>r[4]||(r[4]=[d(" 終了する ")])),_:1},8,["to"])]))],64)):p("",!0)]),_:1})}}});export{We as default};
