import{z as a,ah as p}from"./CvNwVGvF.js";const E=100,L="http://127.0.0.1:8188/api/view?filename={filename}&subfolder={subfolder}&type={type}",l=a(!1),s=a(!1),u=a(""),i=a(0),m=a(0),w=a([]),v=a(0),T=a(0),_=a(0),D=a("");let c=null,n=null;const j=()=>({checkInit:A,isInit:l,isQueue:s,state:u,queueRemaining:i,progress:m,output:w,estimatedTime:_,loadGraph:b,queuePrompt:O,getObjectInfo:S,getPrompt:C,postPrompt:U,postInterrupt:F,upload:{image:async e=>{const r=new FormData;r.append("image",e);try{return await(await fetch("/upload/image",{method:"POST",body:r})).json()}catch(o){throw console.error("There was a problem with the upload:",o),o}}}}),A=async()=>{if(!l.value)return new Promise(e=>{const r=()=>{var d,y,h,P,g,I,x;let o=!1;if(typeof window<"u"&&window.comfyAPI){const q=(h=(y=(d=window.comfyAPI)==null?void 0:d.api)==null?void 0:y.api)==null?void 0:h.clientId;typeof q=="string"&&q!==""&&(l.value=!0,c=(g=(P=window.comfyAPI)==null?void 0:P.app)==null?void 0:g.app,n=(x=(I=window.comfyAPI)==null?void 0:I.api)==null?void 0:x.api,n.addEventListener("execution_start",t=>{u.value="start",v.value=Date.now()}),n.addEventListener("execution_error",()=>{u.value="error",s.value=!1}),n.addEventListener("execution_interrupted",()=>{u.value="error",s.value=!1}),n.addEventListener("executing",()=>{u.value="executing"}),n.addEventListener("executed",t=>{u.value="executed",w.value.push(t.detail.output.images.map(f=>L.replace("{filename}",f.filename).replace("{subfolder}",f.subfolder).replace("{type}",f.type))[0])}),n.addEventListener("progress",t=>{t.detail.value===1?v.value=Date.now():t.detail.value===t.detail.max&&(T.value=Date.now()-v.value,_.value=T.value*i.value),m.value=t.detail.value/t.detail.max}),n.addEventListener("status",t=>{i.value=t.detail.exec_info.queue_remaining,i.value===0&&(s.value=!1)}),o=!0,e())}o||setTimeout(r,E)};r()})},b=async e=>{if(!(!l.value||!c))return await c.loadGraphData(JSON.parse(e))},O=async({json:e="",batchCount:r=1}={})=>{!l.value||!c||s.value||(u.value="",i.value=0,m.value=0,w.value=[],e!==""&&b(e),s.value=!0,c.queuePrompt(1,r))},S=async()=>await p().request("/object_info"),C=async()=>await p().request("/prompt"),U=async e=>await p().request("/prompt",{method:"POST",body:{client_id:D.value,prompt:e}}),F=async()=>await p().request("/interrupt",{method:"POST"});export{j as u};
